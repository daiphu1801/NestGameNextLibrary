# üèóÔ∏è NestGame - Thi·∫øt K·∫ø H·ªá Th·ªëng Full-Stack (Updated)

> C·∫≠p nh·∫≠t sau th·∫£o lu·∫≠n - Ph√¢n t√°ch r√µ tr√°ch nhi·ªám Next.js v√† Spring Boot

---

## üìê 1. Ki·∫øn Tr√∫c T·ªïng Quan

```mermaid
flowchart TB
    subgraph Browser["üñ•Ô∏è Browser"]
        UI["Next.js UI"]
        Emulator["NES Emulator\n(nostalgist)"]
    end
    
    subgraph NextJS["üü¢ Next.js Server"]
        API_ROM["/api/roms\n(Dev/Offline)"]
    end
    
    subgraph SpringBoot["üü† Spring Boot"]
        API_DATA["/api/games\n/api/auth\n/api/users"]
    end
    
    subgraph Storage["üíæ Storage"]
        DB[(PostgreSQL)]
        R2["Cloudflare R2\n(Production ROMs)"]
        Local["LibraryNes/\n(Dev ROMs)"]
    end
    
    UI -->|"GET games data"| API_DATA
    API_DATA --> DB
    
    UI -->|"Play game"| Emulator
    Emulator -->|"Online"| R2
    Emulator -->|"Offline"| API_ROM
    API_ROM --> Local
```

---

## üìÅ 2. C·∫•u Tr√∫c Folder (Monorepo)

```
NestGame/
‚îú‚îÄ‚îÄ frontend/                    # Next.js (move t·ª´ NestGameNext)
‚îÇ   ‚îú‚îÄ‚îÄ LibraryNes/              # ROMs cho dev/offline
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/roms/        # Serve ROMs local
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts           # NEW - G·ªçi Spring Boot API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gameService.ts   # MODIFY - G·ªçi API thay JSON
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ romLocatorService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.tsx  # NEW - Authentication
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ auth/            # NEW - Login/Register modals
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ backend/                     # Spring Boot (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ src/main/java/com/nestgame/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entity/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ src/main/resources/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ application.yml
‚îÇ   ‚îî‚îÄ‚îÄ pom.xml
‚îÇ
‚îú‚îÄ‚îÄ database/                    # ‚úÖ ƒê√£ t·∫°o
‚îÇ   ‚îú‚îÄ‚îÄ schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ sample_data.sql
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ README.md
```

---

## üîÄ 3. Ph√¢n Chia Tr√°ch Nhi·ªám

### Next.js (Frontend)

| Ch·ª©c nƒÉng | M√¥ t·∫£ |
|-----------|-------|
| **UI Components** | Hi·ªÉn th·ªã danh s√°ch games, modals, filters |
| **NES Emulator** | Ch·∫°y emulator trong browser (nostalgist) |
| **ROM Serving** | `/api/roms/` - Serve ROMs cho dev/offline |
| **ROM Source** | Online ‚Üí R2 CDN, Offline ‚Üí local |

### Spring Boot (Backend)

| Ch·ª©c nƒÉng | API Endpoint |
|-----------|--------------|
| **Games Data** | `GET /api/games`, `GET /api/games/{id}` |
| **Search/Filter** | `GET /api/games?category=&search=&page=` |
| **Authentication** | `POST /api/auth/login`, `/register`, `/forgot-password` |
| **User Profile** | `GET/PUT /api/users/me` |
| **Favorites** | `GET/POST/DELETE /api/users/me/favorites` |
| **Play History** | `GET/POST /api/users/me/history` |
| **Admin** | `POST/PUT/DELETE /api/admin/games` |

### ‚ùå Spring Boot KH√îNG l√†m

- Serve ROM files
- Ch·∫°y emulator
- Render UI

---

## üóÉÔ∏è 4. Database Schema (PostgreSQL)

```
‚úÖ ƒê√£ t·∫°o: f:\NestGameNext\database\schema.sql

7 Tables:
‚îú‚îÄ‚îÄ categories      - Lookup table cho categories
‚îú‚îÄ‚îÄ games           - 1714 games (import t·ª´ games.json)
‚îú‚îÄ‚îÄ users           - User accounts
‚îú‚îÄ‚îÄ favorites       - User's favorite games
‚îú‚îÄ‚îÄ play_history    - L·ªãch s·ª≠ ch∆°i
‚îú‚îÄ‚îÄ refresh_tokens  - JWT refresh tokens
‚îî‚îÄ‚îÄ password_reset_tokens - Qu√™n m·∫≠t kh·∫©u (g·ª≠i qua Gmail)
```

---

## üéÆ 5. Flow Ch∆°i Game

```mermaid
sequenceDiagram
    participant User as üë§ User
    participant FE as Next.js
    participant BE as Spring Boot
    participant DB as PostgreSQL
    participant ROM as ROM Source

    Note over User,ROM: 1Ô∏è‚É£ Load game list
    User->>FE: M·ªü /library
    FE->>BE: GET /api/games?category=platformer
    BE->>DB: SELECT * FROM games
    DB-->>BE: Game data
    BE-->>FE: JSON [{id, name, path, ...}]
    FE-->>User: Hi·ªÉn th·ªã cards

    Note over User,ROM: 2Ô∏è‚É£ Play game
    User->>FE: Click "Play Contra"
    FE->>ROM: GET ROM file (R2 ho·∫∑c local)
    ROM-->>FE: Binary file
    FE->>FE: Load v√†o Emulator
    FE-->>User: üéÆ Ch∆°i game!

    Note over User,ROM: 3Ô∏è‚É£ Save favorite (if logged in)
    User->>FE: Click ‚ù§Ô∏è
    FE->>BE: POST /api/users/me/favorites/43 [JWT]
    BE->>DB: INSERT INTO favorites
    BE-->>FE: 200 OK
```

---

## üé® 6. Design Patterns (Spring Boot)

### 4 Patterns C∆° B·∫£n

| Pattern | √Åp d·ª•ng | M·ª•c ƒë√≠ch |
|---------|---------|----------|
| **Repository** | `GameRepository.java` | Truy c·∫≠p database |
| **DTO** | `GameDTO.java` | T√°ch Entity v·ªõi API response |
| **Service Layer** | `GameService.java` | Business logic |
| **MVC** | Controller ‚Üí Service ‚Üí Repository | T√°ch layers |

---

## üìù 7. Implementation Checklist

### Phase 1: Setup ‚úÖ
- [x] Database schema (schema.sql)
- [ ] T·∫°o Spring Boot project
- [ ] Config PostgreSQL connection
- [ ] Import games.json v√†o database

### Phase 2: Core API
- [ ] GameController + GameService
- [ ] CategoryController
- [ ] Pagination & Filtering
- [ ] Search functionality

### Phase 3: Authentication
- [ ] UserController + UserService
- [ ] JWT Token generation
- [ ] Login/Register endpoints
- [ ] Password reset (Gmail)

### Phase 4: User Features
- [ ] Favorites API
- [ ] Play History API

### Phase 5: Frontend Integration
- [ ] Th√™m api.ts service
- [ ] Modify gameService.ts
- [ ] Add AuthContext
- [ ] Login/Register modals

---

## üöÄ B∆∞·ªõc Ti·∫øp Theo

**T·∫°o Spring Boot project** v·ªõi:
1. Maven + Java 17
2. Dependencies: Spring Web, JPA, Security, PostgreSQL
3. Base package: `com.nestgame`
